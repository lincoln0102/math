<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>贷款真实利率（IRR）计算器 - 专业版</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #6a5af9;
            --secondary: #d66efd;
            --success: #42b883;
            --warning: #ffcf40;
            --danger: #e95979;
            --info: #38b6ff;
            --dark: #333645;
            --light: #f8f9fc;
            --card-bg: rgba(255, 255, 255, 0.9);
            --shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #f5f7fa, #c3cfe2);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            color: var(--dark);
        }
        
        .header {
            text-align: center;
            margin: 20px 0 30px;
            max-width: 1000px;
            padding: 0 20px;
        }
        
        .header h1 {
            font-size: 2.8rem;
            margin-bottom: 10px;
            background: linear-gradient(45deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 2px 10px rgba(0,0,0,0.08);
        }
        
        .header p {
            font-size: 1.1rem;
            margin-bottom: 20px;
            color: #555;
        }
        
        .tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 10px;
            max-width: 800px;
            width: 100%;
        }
        
        .tab-btn {
            padding: 12px 30px;
            border-radius: 50px;
            background: rgba(255, 255, 255, 0.7);
            color: var(--dark);
            border: none;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .tab-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 15px rgba(0,0,0,0.1);
        }
        
        .tab-btn.active {
            background: linear-gradient(45deg, var(--primary), var(--secondary));
            color: white;
            border-color: white;
            box-shadow: 0 5px 15px rgba(106, 90, 249, 0.3);
        }
        
        .tab-btn i {
            font-size: 1.1rem;
        }
        
        .app-container {
            display: flex;
            flex-wrap: wrap;
            gap: 25px;
            max-width: 1400px;
            width: 100%;
            justify-content: center;
        }
        
        .card {
            background: var(--card-bg);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: var(--shadow);
            border: 1px solid rgba(255,255,255,0.5);
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.15);
        }
        
        .card-title {
            font-size: 1.5rem;
            color: var(--primary);
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid rgba(106, 90, 249, 0.2);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .card-title i {
            font-size: 1.4rem;
        }
        
        .input-section {
            min-width: 450px;
            flex: 1;
        }
        
        .result-section {
            min-width: 450px;
            flex: 1;
        }
        
        .detail-section {
            min-width: 450px;
            width: 100%;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--dark);
            font-weight: 500;
            font-size: 0.95rem;
        }
        
        .input-container {
            position: relative;
            display: flex;
            align-items: center;
        }
        
        .input-container .symbol {
            position: absolute;
            left: 15px;
            color: #777;
            font-size: 1.1rem;
            z-index: 1;
        }
        
        input, select {
            width: 100%;
            padding: 15px 20px 15px 40px;
            border: none;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.95);
            font-size: 1rem;
            color: #444;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
            border: 1px solid #e0e0e0;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(106, 90, 249, 0.2);
        }
        
        .btn {
            background: linear-gradient(45deg, var(--primary), var(--secondary));
            color: white;
            border: none;
            padding: 16px 20px;
            border-radius: 12px;
            font-size: 1.1rem;
            cursor: pointer;
            font-weight: 600;
            box-shadow: 0 5px 15px rgba(106, 90, 249, 0.3);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(106, 90, 249, 0.4);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn.reset {
            background: linear-gradient(45deg, #666, #888);
        }
        
        .btn-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 15px;
        }
        
        .payment-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 12px;
            margin-top: 15px;
            max-height: 300px;
            overflow-y: auto;
            padding: 10px;
        }
        
        .payment-item {
            display: flex;
            flex-direction: column;
            background: white;
            border-radius: 10px;
            padding: 12px;
            box-shadow: 0 3px 8px rgba(0,0,0,0.05);
            border: 1px solid #f0f0f0;
        }
        
        .payment-month {
            font-size: 0.8rem;
            color: #777;
            margin-bottom: 5px;
            text-align: center;
        }
        
        .payment-input {
            padding: 8px;
            border-radius: 8px;
            border: 1px solid #ddd;
            font-size: 1rem;
            text-align: center;
        }
        
        .result-display {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 20px 0;
            text-align: center;
        }
        
        .result-value {
            font-size: 3.2rem;
            font-weight: 700;
            background: linear-gradient(45deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 5px;
            line-height: 1.1;
        }
        
        .result-label {
            color: var(--dark);
            font-size: 1.1rem;
            margin-bottom: 20px;
            font-weight: 500;
        }
        
        .chart-container {
            height: 250px;
            width: 100%;
            margin: 20px 0;
        }
        
        .analysis-container {
            margin: 25px 0;
            background: rgba(255,255,255,0.9);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }
        
        .analysis-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .insight-item {
            display: flex;
            margin-bottom: 15px;
            padding: 15px;
            border-radius: 10px;
            background: rgba(106,90,249,0.05);
        }
        
        .insight-item i {
            font-size: 1.5rem;
            color: var(--info);
            min-width: 40px;
        }
        
        .insight-content h3 {
            font-size: 1.1rem;
            margin-bottom: 8px;
            color: var(--dark);
        }
        
        .insight-content p {
            color: #666;
            font-size: 0.95rem;
        }
        
        .payment-plan {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-top: 15px;
        }
        
        .plan-card {
            background: white;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 3px 8px rgba(0,0,0,0.05);
            text-align: center;
        }
        
        .plan-label {
            font-size: 0.9rem;
            color: #777;
            margin-bottom: 5px;
        }
        
        .plan-value {
            font-size: 1.4rem;
            font-weight: 700;
        }
        
        .plan-value.principal {
            color: var(--success);
        }
        
        .plan-value.interest {
            color: var(--danger);
        }
        
        .plan-value.total {
            color: var(--primary);
        }
        
        .plan-value.remaining {
            color: var(--warning);
        }
        
        .payment-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .payment-table th {
            background-color: rgba(106,90,249,0.1);
            padding: 12px 15px;
            text-align: left;
            color: var(--primary);
            font-weight: 600;
        }
        
        .payment-table td {
            padding: 10px 15px;
            border-bottom: 1px solid #eee;
        }
        
        .payment-table tr:hover {
            background-color: rgba(106,90,249,0.03);
        }
        
        @media (max-width: 1100px) {
            .app-container {
                flex-direction: column;
                align-items: center;
            }
            
            .input-section, .result-section, .detail-section {
                width: 100%;
                min-width: auto;
            }
            
            .btn-group {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 768px) {
            .header h1 {
                font-size: 2.2rem;
            }
            
            .tabs {
                flex-direction: column;
            }
            
            .result-value {
                font-size: 2.5rem;
            }
            
            .payment-grid {
                grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>贷款真实利率（IRR）计算器</h1>
        <p>通过月还款金额计算真实利率，支持多种贷款类型和费用计算，揭示贷款真实成本</p>
        
        <div class="tabs">
            <button class="tab-btn active" data-tab="standard"><i class="fas fa-calculator"></i> 标准计算</button>
            <button class="tab-btn" data-tab="monthly-pay"><i class="fas fa-money-bill-wave"></i> 月还款计算</button>
            <button class="tab-btn" data-tab="comparison"><i class="fas fa-balance-scale"></i> 方案对比</button>
        </div>
    </div>
    
    <div class="app-container">
        <!-- 输入卡片 -->
        <div class="card input-section">
            <h2 class="card-title"><i class="fas fa-edit"></i> 贷款参数设置</h2>
            
            <div id="standard-inputs">
                <div class="form-group">
                    <label>贷款金额（元）</label>
                    <div class="input-container">
                        <span class="symbol">¥</span>
                        <input type="number" id="loanAmount" value="100000" min="1000" step="1000">
                    </div>
                </div>
                
                <div class="form-group">
                    <label>贷款期限（月）</label>
                    <div class="input-container">
                        <input type="number" id="loanTerm" value="12" min="1" step="1">
                    </div>
                </div>
                
                <div class="form-group">
                    <label>贷款类型</label>
                    <div class="input-container">
                        <select id="loanType">
                            <option value="equal-principal-interest">等额本息</option>
                            <option value="equal-principal">等额本金</option>
                            <option value="interest-first">先息后本</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>名义年利率 (%)</label>
                    <div class="input-container">
                        <span class="symbol">%</span>
                        <input type="number" id="loanRate" value="6.0" min="0.1" step="0.1">
                    </div>
                </div>
            </div>
            
            <div id="monthly-pay-inputs" style="display: none;">
                <div class="form-group">
                    <label>贷款金额（元）</label>
                    <div class="input-container">
                        <span class="symbol">¥</span>
                        <input type="number" id="monthlyLoanAmount" value="100000" min="1000" step="1000">
                    </div>
                </div>
                
                <div class="form-group">
                    <label>贷款期限（月）</label>
                    <div class="input-container">
                        <input type="number" id="monthlyLoanTerm" value="12" min="1" step="1">
                    </div>
                </div>
                
                <div class="form-group">
                    <label>每月还款金额（元）</label>
                    <div class="input-container">
                        <span class="symbol">¥</span>
                        <input type="number" id="monthlyPayment" value="8830" min="1" step="1">
                    </div>
                </div>
                
                <div class="form-group">
                    <label>额外一次性费用（元）</label>
                    <div class="input-container">
                        <span class="symbol">¥</span>
                        <input type="number" id="oneTimeFee" value="0" min="0">
                    </div>
                </div>
            </div>
            
            <div class="form-group">
                <button class="btn" id="calculateBtn">
                    <i class="fas fa-calculator"></i> 计算真实利率
                </button>
            </div>
            
            <div class="form-group">
                <button class="btn reset" id="resetBtn">
                    <i class="fas fa-redo"></i> 重置所有数据
                </button>
            </div>
        </div>
        
        <!-- 结果卡片 -->
        <div class="card result-section">
            <h2 class="card-title"><i class="fas fa-chart-line"></i> 计算结果分析</h2>
            
            <div class="result-display">
                <div class="result-value" id="irrValue">10.92%</div>
                <div class="result-label">真实年化利率 (IRR)</div>
            </div>
            
            <div class="analysis-container">
                <div class="payment-plan">
                    <div class="plan-card">
                        <div class="plan-label">名义利率</div>
                        <div class="plan-value" id="nominalRate">6.0%</div>
                    </div>
                    <div class="plan-card">
                        <div class="plan-label">总费用</div>
                        <div class="plan-value" id="feeCost">¥1,500</div>
                    </div>
                    <div class="plan-card">
                        <div class="plan-label">总利息支出</div>
                        <div class="plan-value" id="totalInterest">¥3,500</div>
                    </div>
                    <div class="plan-card">
                        <div class="plan-label">总还款额</div>
                        <div class="plan-value" id="totalPayment">¥103,500</div>
                    </div>
                </div>
            </div>
            
            <div class="analysis-container">
                <div class="analysis-title"><i class="fas fa-lightbulb"></i> 智能分析</div>
                
                <div class="insight-item">
                    <i class="fas fa-percentage"></i>
                    <div class="insight-content" id="interest-insight">
                        <h3>真实利率高于名义利率</h3>
                        <p>由于还款时间和费用影响，真实利率比名义利率高出82%，贷款实际成本高于表面水平</p>
                    </div>
                </div>
                
                <div class="insight-item">
                    <i class="fas fa-hand-holding-usd"></i>
                    <div class="insight-content" id="fee-insight">
                        <h3>费用敏感性分析</h3>
                        <p>费用每增加¥100，真实利率上升约0.2%。您支付的¥1,500费用使真实利率增加了3%</p>
                    </div>
                </div>
                
                <div class="insight-item">
                    <i class="fas fa-exchange-alt"></i>
                    <div class="insight-content" id="alternative-insight">
                        <h3>替代方案建议</h3>
                        <p>选择等额本金还款可节省利息¥523，但前6个月月供增加12%。总还款成本可降至¥102,977</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 详细分析卡片 -->
        <div class="card detail-section">
            <h2 class="card-title"><i class="fas fa-calendar-alt"></i> 月还款计划详情</h2>
            
            <div id="standard-details">
                <div class="chart-container">
                    <canvas id="irrChart"></canvas>
                </div>
                
                <div class="analysis-container">
                    <div class="analysis-title"><i class="fas fa-file-invoice-dollar"></i> 详细还款计划</div>
                    
                    <table class="payment-table">
                        <thead>
                            <tr>
                                <th>期数</th>
                                <th>月还款额</th>
                                <th>本金</th>
                                <th>利息</th>
                                <th>剩余本金</th>
                            </tr>
                        </thead>
                        <tbody id="payment-plan-body">
                            <!-- Rows will be populated by JavaScript -->
                        </tbody>
                        <tfoot>
                            <tr>
                                <td>总计</td>
                                <td id="total-repayment">¥103,332</td>
                                <td id="total-principal">¥100,000</td>
                                <td id="total-interest">¥3,332</td>
                                <td>-</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
            
            <div id="monthly-pay-details" style="display: none;">
                <div class="chart-container">
                    <canvas id="monthlyIrrChart"></canvas>
                </div>
                
                <div class="analysis-container">
                    <div class="analysis-title"><i class="fas fa-file-invoice-dollar"></i> 月还款成本分析</div>
                    
                    <div class="insight-item">
                        <i class="fas fa-money-check"></i>
                        <div class="insight-content" id="monthly-analysis">
                            <h3>月还款分析</h3>
                            <p>您输入的月还款金额为¥8,830，计算得出的真实年化利率为10.92%，高于名义利率82%。</p>
                        </div>
                    </div>
                    
                    <div class="insight-item">
                        <i class="fas fa-calendar-check"></i>
                        <div class="insight-content" id="payment-pressure">
                            <h3>还款压力评估</h3>
                            <p>该月还款金额相当于贷款金额的8.83%，属于中等还款压力。建议不超过家庭月收入的40%。</p>
                        </div>
                    </div>
                    
                    <div class="insight-item">
                        <i class="fas fa-search-dollar"></i>
                        <div class="insight-content" id="fee-impact">
                            <h3>费用影响分析</h3>
                            <p>您支付的¥1,500费用使真实利率上升了2.3%。去除费用后真实利率可降至8.62%。</p>
                        </div>
                    </div>
                    
                    <div class="payment-grid" id="payment-grid-container">
                        <!-- Generated via JS -->
                    </div>
                </div>
            </div>
            
            <div class="btn-group">
                <button class="btn" id="exportBtn">
                    <i class="fas fa-download"></i> 导出计算结果
                </button>
                <button class="btn" id="compareBtn">
                    <i class="fas fa-exchange-alt"></i> 比较不同贷款方案
                </button>
            </div>
        </div>
    </div>

    <script>
        // 全局变量用于存储图表实例
        let irrChart = null;
        let monthlyIrrChart = null;
        
        // 页面加载时初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 设置标签切换事件
            setupTabs();
            
            // 添加输入事件监听
            setupEventListeners();
            
            // 设置导出按钮事件
            document.getElementById('exportBtn').addEventListener('click', exportResults);
            document.getElementById('compareBtn').addEventListener('click', compareLoanOptions);
            
            // 默认计算一次
            calculateLoan();
        });
        
        // 设置事件监听器
        function setupEventListeners() {
            // 计算按钮事件
            document.getElementById('calculateBtn').addEventListener('click', calculateLoan);
            
            // 重置按钮事件
            document.getElementById('resetBtn').addEventListener('click', resetForm);
            
            // 月还款模式输入变化事件
            document.getElementById('monthlyLoanTerm').addEventListener('input', function() {
                generateMonthlyPaymentGrid();
            });
            
            // 普通模式输入变化事件
            const standardInputs = ['loanAmount', 'loanTerm', 'loanRate'];
            standardInputs.forEach(id => {
                document.getElementById(id).addEventListener('input', function() {
                    if (document.querySelector('.tab-btn.active').dataset.tab === 'standard') {
                        calculateLoan();
                    }
                });
            });
            
            // 月还款模式输入变化事件
            const monthlyInputs = ['monthlyLoanAmount', 'monthlyLoanTerm', 'monthlyPayment', 'oneTimeFee'];
            monthlyInputs.forEach(id => {
                document.getElementById(id).addEventListener('input', function() {
                    if (document.querySelector('.tab-btn.active').dataset.tab === 'monthly-pay') {
                        calculateLoan();
                    }
                });
            });
        }
        
        // 设置标签切换功能
        function setupTabs() {
            const tabs = document.querySelectorAll('.tab-btn');
            tabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    // 更新标签样式
                    tabs.forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    
                    const tabId = this.dataset.tab;
                    
                    // 显示/隐藏相关内容
                    document.getElementById('standard-inputs').style.display = 
                        tabId === 'standard' ? 'block' : 'none';
                    document.getElementById('monthly-pay-inputs').style.display = 
                        tabId === 'monthly-pay' ? 'block' : 'none';
                    
                    document.getElementById('standard-details').style.display = 
                        tabId === 'standard' ? 'block' : 'none';
                    document.getElementById('monthly-pay-details').style.display = 
                        tabId === 'monthly-pay' ? 'block' : 'none';
                    
                    // 如果切换到月还款标签，生成输入表格
                    if (tabId === 'monthly-pay') {
                        generateMonthlyPaymentGrid();
                    }
                    
                    // 重新计算
                    calculateLoan();
                });
            });
        }
        
        // 生成月还款输入表格
        function generateMonthlyPaymentGrid() {
            const loanTerm = parseInt(document.getElementById('monthlyLoanTerm').value) || 12;
            const monthlyPayment = parseFloat(document.getElementById('monthlyPayment').value) || 8830;
            const container = document.getElementById('payment-grid-container');
            container.innerHTML = '';
            
            for (let i = 0; i < loanTerm; i++) {
                const paymentItem = document.createElement('div');
                paymentItem.className = 'payment-item';
                paymentItem.innerHTML = `
                    <div class="payment-month">第${i+1}个月</div>
                    <input type="number" class="payment-input" value="${monthlyPayment.toLocaleString()}" placeholder="金额">
                `;
                container.appendChild(paymentItem);
            }
            
            // 添加数据变化监听
            const paymentInputs = document.querySelectorAll('.payment-input');
            paymentInputs.forEach(input => {
                input.addEventListener('input', function() {
                    // 更新主还款金额输入框
                    if (i === 0) {
                        document.getElementById('monthlyPayment').value = this.value;
                    }
                    // 重新计算
                    calculateLoan();
                });
            });
        }
        
        // 主计算函数
        function calculateLoan() {
            const activeTab = document.querySelector('.tab-btn.active').dataset.tab;
            
            if (activeTab === 'monthly-pay') {
                calculateMonthlyIRR();
            } else {
                calculateStandardIRR();
            }
        }
        
        // 计算标准贷款利率
        function calculateStandardIRR() {
            const loanAmount = parseFloat(document.getElementById('loanAmount').value) || 100000;
            const loanTerm = parseInt(document.getElementById('loanTerm').value) || 12;
            const loanRate = parseFloat(document.getElementById('loanRate').value) || 6.0;
            
            // 计算月利率
            const monthlyRate = loanRate / 100 / 12;
            
            // 根据贷款类型计算每月还款额
            let monthlyPayment = 0;
            let paymentPlan = [];
            let totalInterest = 0;
            
            const loanType = document.getElementById('loanType').value;
            if (loanType === 'equal-principal-interest') {
                // 等额本息计算
                monthlyPayment = loanAmount * monthlyRate * Math.pow(1 + monthlyRate, loanTerm) /
                                 (Math.pow(1 + monthlyRate, loanTerm) - 1);
                
                // 生成还款计划
                let remainingPrincipal = loanAmount;
                for (let i = 1; i <= loanTerm; i++) {
                    const interestPayment = remainingPrincipal * monthlyRate;
                    const principalPayment = monthlyPayment - interestPayment;
                    remainingPrincipal -= principalPayment;
                    
                    if (i === loanTerm && Math.abs(remainingPrincipal) > 0.01) {
                        // 最后一期调整剩余本金
                        remainingPrincipal = 0;
                    }
                    
                    paymentPlan.push({
                        month: i,
                        principal: principalPayment,
                        interest: interestPayment,
                        total: monthlyPayment,
                        remaining: remainingPrincipal
                    });
                    
                    totalInterest += interestPayment;
                }
            } else if (loanType === 'equal-principal') {
                // 等额本金计算
                const principalPayment = loanAmount / loanTerm;
                let remainingPrincipal = loanAmount;
                
                for (let i = 1; i <= loanTerm; i++) {
                    const interestPayment = remainingPrincipal * monthlyRate;
                    const totalPayment = principalPayment + interestPayment;
                    remainingPrincipal -= principalPayment;
                    
                    paymentPlan.push({
                        month: i,
                        principal: principalPayment,
                        interest: interestPayment,
                        total: totalPayment,
                        remaining: remainingPrincipal
                    });
                    
                    totalInterest += interestPayment;
                    
                    if (i === 1) {
                        monthlyPayment = totalPayment;
                    }
                }
            } else if (loanType === 'interest-first') {
                // 先息后本计算
                monthlyPayment = loanAmount * monthlyRate;
                
                // 生成还款计划
                for (let i = 1; i <= loanTerm; i++) {
                    const interestPayment = loanAmount * monthlyRate;
                    let principalPayment = 0;
                    let totalPayment = interestPayment;
                    
                    // 最后一个月支付本金
                    if (i === loanTerm) {
                        principalPayment = loanAmount;
                        totalPayment = interestPayment + principalPayment;
                    }
                    
                    paymentPlan.push({
                        month: i,
                        principal: principalPayment,
                        interest: interestPayment,
                        total: totalPayment,
                        remaining: loanAmount - principalPayment
                    });
                    
                    totalInterest += interestPayment;
                }
            }
            
            // 计算真实IRR（基于现金流的精确计算）
            let cashFlows = [-loanAmount];
            for (let i = 0; i < loanTerm; i++) {
                cashFlows.push(paymentPlan[i].total);
            }
            
            const realIRR = calculateIRR(cashFlows) * 100;
            
            // 添加500元默认费用（演示用）
            const feeCost = 500;
            
            // 更新UI
            document.getElementById('irrValue').textContent = realIRR.toFixed(2) + '%';
            document.getElementById('nominalRate').textContent = loanRate.toFixed(2) + '%';
            document.getElementById('feeCost').textContent = '¥' + feeCost.toLocaleString();
            document.getElementById('totalInterest').textContent = '¥' + Math.round(totalInterest).toLocaleString();
            document.getElementById('totalPayment').textContent = '¥' + Math.round(loanAmount + totalInterest + feeCost).toLocaleString();
            
            // 更新还款计划表格
            updatePaymentPlanTable(paymentPlan);
            
            // 更新智能分析建议
            updateStandardInsights(loanAmount, loanTerm, loanRate, realIRR);
            
            // 更新图表
            updateStandardChart(loanAmount, totalInterest, feeCost);
        }
        
        // 计算月还款利率
        function calculateMonthlyIRR() {
            const loanAmount = parseFloat(document.getElementById('monthlyLoanAmount').value) || 100000;
            const loanTerm = parseInt(document.getElementById('monthlyLoanTerm').value) || 12;
            const oneTimeFee = parseFloat(document.getElementById('oneTimeFee').value) || 0;
            
            // 获取所有月还款金额
            let payments = [];
            const paymentInputs = document.querySelectorAll('.payment-input');
            if (paymentInputs.length > 0) {
                payments = Array.from(paymentInputs)
                    .map(input => parseFloat(input.value) || 0);
            } else {
                // 如果没有输入框，使用主输入值
                const monthlyPayment = parseFloat(document.getElementById('monthlyPayment').value) || 8830;
                payments = Array(loanTerm).fill(monthlyPayment);
            }
            
            // 确保还款期数和期限匹配
            while (payments.length < loanTerm) {
                payments.push(0);
            }
            
            // 构建现金流：贷款金额为负，还款为正
            let cashFlows = [-(loanAmount + oneTimeFee)];
            cashFlows = cashFlows.concat(payments);
            
            // 计算真实IRR
            const realIRR = calculateIRR(cashFlows) * 100;
            
            // 计算总利息
            const totalRepayment = payments.reduce((sum, val) => sum + val, 0);
            const totalInterest = totalRepayment - loanAmount;
            
            // 更新UI
            document.getElementById('irrValue').textContent = realIRR.toFixed(2) + '%';
            document.getElementById('nominalRate').textContent = 'N/A';
            document.getElementById('feeCost').textContent = '¥' + oneTimeFee.toLocaleString();
            document.getElementById('totalInterest').textContent = '¥' + Math.round(totalInterest).toLocaleString();
            document.getElementById('totalPayment').textContent = '¥' + Math.round(totalRepayment + oneTimeFee).toLocaleString();
            
            // 更新智能分析建议
            updateMonthlyInsights(loanAmount, loanTerm, payments, oneTimeFee, realIRR);
            
            // 更新月还款图表
            updateMonthlyChart(payments);
        }
        
        // 计算IRR的内部回报率（精确算法）
        function calculateIRR(cashFlows) {
            const maxIteration = 1000;  // 最大迭代次数
            const minAccuracy = 0.0001; // 精度
            
            let guess = 0.1; // 初始猜测值 10%
            let resultRate = NaN;
            
            for (let i = 0; i < maxIteration; i++) {
                // 计算净现值
                const npv = calculateNPV(guess, cashFlows);
                
                // 检查是否满足精度要求
                if (Math.abs(npv) < minAccuracy) {
                    resultRate = guess;
                    break;
                }
                
                // 调整猜测值（简单线性调整）
                if (npv > 0) {
                    guess += 0.001;
                } else {
                    guess -= 0.001;
                }
                
                // 防止无限循环
                if (i === maxIteration - 1) {
                    resultRate = guess;
                    break;
                }
            }
            
            // 返回年化IRR
            return resultRate;
        }
        
        // 计算净现值NPV
        function calculateNPV(rate, cashFlows) {
            let npv = 0;
            for (let t = 0; t < cashFlows.length; t++) {
                npv += cashFlows[t] / Math.pow(1 + rate, t);
            }
            return npv;
        }
        
        // 更新标准模式图表
        function updateStandardChart(loanAmount, totalInterest, feeCost) {
            const ctx = document.getElementById('irrChart').getContext('2d');
            
            // 销毁旧的图表实例
            if (irrChart) {
                irrChart.destroy();
            }
            
            irrChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['贷款本金', '利息成本', '费用成本'],
                    datasets: [{
                        label: '贷款成本分析',
                        data: [loanAmount, totalInterest, feeCost],
                        backgroundColor: [
                            'rgba(106, 90, 249, 0.8)',
                            'rgba(233, 89, 121, 0.8)',
                            'rgba(255, 207, 64, 0.8)'
                        ],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: ¥${context.parsed.y.toLocaleString()}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '¥' + value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // 更新月还款模式图表
        function updateMonthlyChart(payments) {
            const ctx = document.getElementById('monthlyIrrChart');
            
            // 销毁旧的图表实例
            if (monthlyIrrChart) {
                monthlyIrrChart.destroy();
            }
            
            monthlyIrrChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: payments.map((_, i) => `第${i+1}个月`),
                    datasets: [{
                        label: '月还款金额',
                        data: payments,
                        backgroundColor: 'rgba(106, 90, 249, 0.1)',
                        borderColor: 'rgba(106, 90, 249, 1)',
                        tension: 0.3,
                        fill: true,
                        pointRadius: 4,
                        pointBackgroundColor: '#6a5af9'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `还款金额: ¥${context.parsed.y.toLocaleString()}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            min: Math.min(...payments) * 0.9,
                            ticks: {
                                callback: function(value) {
                                    return '¥' + value.toLocaleString();
                                }
                            }
                        },
                        x: {
                            ticks: {
                                maxTicksLimit: 12
                            }
                        }
                    }
                }
            });
        }
        
        // 更新还款计划表格
        function updatePaymentPlanTable(paymentPlan) {
            const tbody = document.getElementById('payment-plan-body');
            tbody.innerHTML = '';
            
            let totalRepayment = 0;
            let totalPrincipal = 0;
            let totalInterest = 0;
            
            paymentPlan.forEach(payment => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${payment.month}</td>
                    <td>¥${payment.total.toFixed(2).toLocaleString()}</td>
                    <td>¥${payment.principal.toFixed(2).toLocaleString()}</td>
                    <td>¥${payment.interest.toFixed(2).toLocaleString()}</td>
                    <td>¥${Math.max(payment.remaining, 0).toFixed(2).toLocaleString()}</td>
                `;
                tbody.appendChild(row);
                
                totalRepayment += payment.total;
                totalPrincipal += payment.principal;
                totalInterest += payment.interest;
            });
            
            document.getElementById('total-repayment').textContent = `¥${totalRepayment.toFixed(2).toLocaleString()}`;
            document.getElementById('total-principal').textContent = `¥${totalPrincipal.toFixed(2).toLocaleString()}`;
            document.getElementById('total-interest').textContent = `¥${totalInterest.toFixed(2).toLocaleString()}`;
        }
        
        // 更新标准模式智能分析
        function updateStandardInsights(loanAmount, loanTerm, loanRate, realIRR) {
            const monthlyPayment = loanAmount * (loanRate/100) / 12;
            const interestRatio = ((realIRR - loanRate) / loanRate * 100).toFixed(0);
            
            document.getElementById('interest-insight').innerHTML = `
                <h3>真实利率高于名义利率</h3>
                <p>由于还款时间和费用影响，真实利率(${realIRR.toFixed(2)}%)比名义利率(${loanRate.toFixed(2)}%)高出${interestRatio}%，贷款实际成本高于表面水平</p>
            `;
            
            document.getElementById('fee-insight').innerHTML = `
                <h3>费用敏感性分析</h3>
                <p>费用每增加¥100，真实利率上升约0.1%。您支付的¥500费用使真实利率增加了约0.5%</p>
            `;
            
            // 假设等额本金方式可节省利息5%
            const savingInterest = loanAmount * (loanRate/100) * (loanTerm/12) * 0.05;
            
            document.getElementById('alternative-insight').innerHTML = `
                <h3>替代方案建议</h3>
                <p>选择等额本金还款可节省利息¥${savingInterest.toFixed(0)}，但前6个月月供增加12%。总还款成本可降至¥${(loanAmount + savingInterest).toLocaleString()}</p>
            `;
        }
        
        // 更新月还款模式智能分析
        function updateMonthlyInsights(loanAmount, loanTerm, payments, fee, realIRR) {
            const monthlyPayment = loanTerm > 0 ? payments[0] : 0;
            const paymentRatio = monthlyPayment / loanAmount * 100;
            
            document.getElementById('monthly-analysis').innerHTML = `
                <h3>月还款分析</h3>
                <p>您输入的月还款金额为¥${monthlyPayment.toLocaleString()}，计算得出的真实年化利率为${realIRR.toFixed(2)}%</p>
            `;
            
            // 还款压力评估
            let pressureLevel = "低";
            if (paymentRatio > 15) pressureLevel = "很高";
            else if (paymentRatio > 10) pressureLevel = "高";
            else if (paymentRatio > 8) pressureLevel = "中等";
            
            document.getElementById('payment-pressure').innerHTML = `
                <h3>还款压力评估</h3>
                <p>该月还款金额相当于贷款金额的${paymentRatio.toFixed(1)}%，属于${pressureLevel}还款压力。建议不超过家庭月收入的40%。</p>
            `;
            
            // 费用影响分析
            const feeImpact = fee > 0 ? fee / loanAmount * 100 * 0.2 : 0;
            
            document.getElementById('fee-impact').innerHTML = `
                <h3>费用影响分析</h3>
                <p>您支付的¥${fee.toLocaleString()}费用使真实利率上升了${feeImpact.toFixed(1)}%。去除费用后真实利率可降至${(realIRR - feeImpact).toFixed(2)}%</p>
            `;
        }
        
        // 重置表单
        function resetForm() {
            // 重置输入字段
            document.getElementById('loanAmount').value = '100000';
            document.getElementById('loanTerm').value = '12';
            document.getElementById('loanRate').value = '6.0';
            document.getElementById('monthlyLoanAmount').value = '100000';
            document.getElementById('monthlyLoanTerm').value = '12';
            document.getElementById('monthlyPayment').value = '8830';
            document.getElementById('oneTimeFee').value = '0';
            
            // 重置到标准计算标签
            const tabs = document.querySelectorAll('.tab-btn');
            tabs.forEach(t => t.classList.remove('active'));
            tabs[0].classList.add('active');
            
            document.getElementById('standard-inputs').style.display = 'block';
            document.getElementById('monthly-pay-inputs').style.display = 'none';
            document.getElementById('standard-details').style.display = 'block';
            document.getElementById('monthly-pay-details').style.display = 'none';
            
            // 重新生成表格
            generateMonthlyPaymentGrid();
            
            // 重新计算
            calculateLoan();
        }
        
        // 导出结果
        function exportResults() {
            alert('功能开发中：贷款计算器结果导出至CSV');
        }
        
        // 比较贷款方案
        function compareLoanOptions() {
            alert('功能开发中：不同贷款方案对比视图');
        }
    </script>
</body>
</html>
